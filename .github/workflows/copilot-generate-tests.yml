name: Copilot Agent - Generate Tests

on:
  issues:
    types: [opened, assigned, labeled, edited, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to analyze and generate tests for
        required: true
      changed_files:
        description: Newline-separated list of changed Java source files
        required: false
      frameworks_hint:
        description: Optional hint of frameworks found (JUnit5, SpringBootTest, Mockito, Cucumber, Testcontainers)
        required: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Parse branch from issue or use input
        id: parse_branch
        uses: actions/github-script@v7
        with:
          script: |
            let branch = '${{ inputs.branch }}';
            let changedFiles = '${{ inputs.changed_files }}';
            let frameworksHint = '${{ inputs.frameworks_hint }}';
            
            if (context.eventName === 'issues') {
              const labels = context.payload.issue.labels.map(l => l.name);
              if (!labels.includes('copilot-agent')) {
                console.log('Issue not labeled with "copilot-agent", skipping workflow');
                core.setOutput('should_skip', 'true');
                return;
              }
              
              const issueBody = context.payload.issue.body || '';
              const issueTitle = context.payload.issue.title || '';
              
              // Try to extract branch from issue body first (most reliable)
              let branchMatch = issueBody.match(/Branch:\s*([^\n\s]+)/);
              if (branchMatch) {
                branch = branchMatch[1];
                console.log(`Branch extracted from issue body: ${branch}`);
              } else {
                // Fallback: try to extract from issue title
                // Format: "Generate tests for branch {branch_name} (repo)"
                const titleMatch = issueTitle.match(/Generate tests for branch\s+([^\s\(]+)/);
                if (titleMatch) {
                  branch = titleMatch[1];
                  console.log(`Branch extracted from issue title: ${branch}`);
                } else {
                  console.log('Could not parse branch from issue body or title, defaulting to main');
                  branch = 'main';
                }
              }
              
              // Extract changed files from issue body
              const filesSection = issueBody.match(/Changed files:[\s\S]*?(?=\n\n|Prefer|Branch:|$)/);
              if (filesSection) {
                const fileMatches = filesSection[0].matchAll(/[-â€¢]\s*(.+\.java)/g);
                changedFiles = Array.from(fileMatches, m => m[1].trim()).join('\n');
              }
            } else if (context.eventName === 'issue_comment') {
              const labels = context.payload.issue.labels.map(l => l.name);
              if (!labels.includes('copilot-agent')) {
                console.log('Issue not labeled with "copilot-agent", skipping workflow');
                core.setOutput('should_skip', 'true');
                return;
              }

              const issueBody = context.payload.issue.body || '';
              const issueTitle = context.payload.issue.title || '';

              let branchMatch = issueBody.match(/Branch:\s*([^\n\s]+)/);
              if (branchMatch) {
                branch = branchMatch[1];
                console.log(`Branch extracted from issue body: ${branch}`);
              } else {
                const titleMatch = issueTitle.match(/Generate tests for branch\s+([^\s\(]+)/);
                if (titleMatch) {
                  branch = titleMatch[1];
                  console.log(`Branch extracted from issue title: ${branch}`);
                } else {
                  console.log('Could not parse branch from issue body or title, defaulting to main');
                  branch = 'main';
                }
              }

              const filesSection = issueBody.match(/Changed files:[\s\S]*?(?=\n\n|Prefer|Branch:|$)/);
              if (filesSection) {
                const fileMatches = filesSection[0].matchAll(/[-â€¢]\s*(.+\.java)/g);
                changedFiles = Array.from(fileMatches, m => m[1].trim()).join('\n');
              }
            }
            
            console.log(`Final Branch: ${branch}`);
            console.log(`Changed files:\n${changedFiles}`);
            core.setOutput('branch', branch);
            core.setOutput('changed_files', changedFiles);
            core.setOutput('frameworks_hint', frameworksHint);
            core.setOutput('should_skip', 'false');

      - name: Skip if not for copilot
        if: steps.parse_branch.outputs.should_skip == 'true'
        run: |
          echo "Skipping workflow - issue missing copilot-agent label"
          exit 0

      - name: Checkout target branch
        if: steps.parse_branch.outputs.should_skip == 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.parse_branch.outputs.branch }}

      - name: Setup Java
        if: steps.parse_branch.outputs.should_skip == 'false'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Analyze project dependencies and frameworks
        if: steps.parse_branch.outputs.should_skip == 'false'
        id: analyze
        run: |
          echo "Detecting existing test frameworks in src/test..."
          frameworks=""
          if grep -R "org.junit.jupiter" src/test 2>/dev/null; then frameworks="${frameworks}JUnit5, "; fi
          if grep -R "@SpringBootTest" src/test 2>/dev/null; then frameworks="${frameworks}SpringBootTest, "; fi
          if grep -R "org.mockito" src/test 2>/dev/null; then frameworks="${frameworks}Mockito, "; fi
          if grep -R "io.cucumber" src/test 2>/dev/null; then frameworks="${frameworks}Cucumber, "; fi
          if grep -R "org.testcontainers" src/test 2>/dev/null; then frameworks="${frameworks}Testcontainers, "; fi
          frameworks="${frameworks%, }"
          echo "frameworks=${frameworks}" >> $GITHUB_OUTPUT
          
          echo "Analyzing pom.xml dependencies..."
          dependencies=""
          
          # Check for Spring Web
          if grep -q "spring-boot-starter-web" pom.xml; then 
            dependencies="${dependencies}spring-web, "
          fi
          
          # Check for Spring Data JPA
          if grep -q "spring-boot-starter-data-jpa" pom.xml; then 
            dependencies="${dependencies}spring-data-jpa, "
          fi
          
          # Check for Spring Data JDBC
          if grep -q "spring-boot-starter-data-jdbc" pom.xml; then 
            dependencies="${dependencies}spring-data-jdbc, "
          fi
          
          # Check for Spring Data Redis
          if grep -q "spring-boot-starter-data-redis" pom.xml; then 
            dependencies="${dependencies}spring-data-redis, "
          fi
          
          # Check for Spring Data MongoDB
          if grep -q "spring-boot-starter-data-mongodb" pom.xml; then 
            dependencies="${dependencies}spring-data-mongodb, "
          fi
          
          # Check for Spring Kafka
          if grep -q "spring-kafka" pom.xml; then 
            dependencies="${dependencies}spring-kafka, "
          fi
          
          # Check for Spring AMQP/RabbitMQ
          if grep -q "spring-boot-starter-amqp" pom.xml; then 
            dependencies="${dependencies}spring-amqp, "
          fi
          
          # Check for WebFlux
          if grep -q "spring-boot-starter-webflux" pom.xml; then 
            dependencies="${dependencies}spring-webflux, "
          fi
          
          dependencies="${dependencies%, }"
          echo "dependencies=${dependencies}" >> $GITHUB_OUTPUT
          
          echo "Detected dependencies: ${dependencies}"

      - name: Create or update issue to trigger Copilot Coding Agent
        if: steps.parse_branch.outputs.should_skip == 'false'
        id: create_issue
        uses: actions/github-script@v7
        env:
          CHANGED_FILES: ${{ steps.parse_branch.outputs.changed_files }}
          FRAMEWORKS_HINT: ${{ steps.parse_branch.outputs.frameworks_hint }}
          ANALYZED_FRAMEWORKS: ${{ steps.analyze.outputs.frameworks }}
          DEPENDENCIES: ${{ steps.analyze.outputs.dependencies }}
          BRANCH_NAME: ${{ steps.parse_branch.outputs.branch }}
        with:
          script: |
            try {
              const branch = (process.env.BRANCH_NAME || 'main').trim();
              const changedFilesRaw = (process.env.CHANGED_FILES || '').trim();
              const changedFiles = changedFilesRaw ? changedFilesRaw.split('\n').map(f => '- ' + f.trim()).join('\n') : '';
              const frameworksHint = (process.env.FRAMEWORKS_HINT || process.env.ANALYZED_FRAMEWORKS || '').trim();
              const dependencies = (process.env.DEPENDENCIES || '').trim();
              
              const issueTitle = 'Generate tests for branch ' + branch + ' (beneficiaries)';
              
              let issueBody = 'Please analyze the beneficiaries repo on branch ' + branch + ' and generate tests for changed Java sources.\n\n';
              issueBody += '**Context:**\n';
              issueBody += '- Branch: ' + branch + '\n';
              issueBody += '- Changed files:\n' + (changedFiles || 'Analyze all recent changes on branch') + '\n';
              issueBody += '- Existing test frameworks detected: ' + (frameworksHint || 'None detected') + '\n';
              issueBody += '- Dependencies found in pom.xml: ' + (dependencies || 'None detected') + '\n\n';
              issueBody += '#github-pull-request_copilot-coding-agent';

              // Check for existing open issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'copilot-agent,tests'
              });

              const existingIssue = issues.find(issue => issue.title === issueTitle);
              let issueNumber;

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
              issueNumber = existingIssue.number;
            } else {
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['copilot-agent', 'tests']
              });
              console.log(`Created new issue #${newIssue.number}`);
              issueNumber = newIssue.number;
            }
            
            // Assign @copilot to the issue
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                assignees: ['copilot']
              });
              console.log(`Assigned @copilot to issue #${issueNumber}`);
            } catch (assignError) {
              console.warn(`Could not assign @copilot to issue #${issueNumber}:`, assignError.message);
            }
            
            core.setOutput('issue_number', issueNumber);
            } catch (error) {
              console.error('Error creating issue:', error);
              throw error;
            }

      - name: Trigger Copilot Agent with comment
        if: steps.parse_branch.outputs.should_skip == 'false'
        id: trigger_agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create_issue.outputs.issue_number }};
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: '@copilot #github-pull-request_copilot-coding-agent\n\nPlease generate tests for the changed files mentioned above.'
              });
              console.log(`Triggered @copilot on issue #${issueNumber}`);
            } catch (error) {
              console.error('Error triggering agent:', error);
              throw error;
            }

      - name: Wait for Copilot Agent to create or update PR
        if: steps.parse_branch.outputs.should_skip == 'false'
        id: wait_for_pr
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.create_issue.outputs.issue_number }}');
            const maxAttempts = 60; // Wait up to 30 minutes (30s * 60)
            const delayMs = 30000; // 30 seconds between checks
            
            let attempt = 0;
            let prFound = false;
            let prNumber = null;
            let prBranch = null;
            
            console.log(`Waiting for Copilot Agent to respond to issue #${issueNumber}...`);
            
            while (attempt < maxAttempts && !prFound) {
              attempt++;
              console.log(`Attempt ${attempt}/${maxAttempts}...`);
              
              // Check if issue was closed by Copilot without creating a PR
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              if (issue.state === 'closed') {
                console.log('Issue was closed without creating a PR. Agent may have determined no tests were needed.');
                core.setOutput('pr_created', 'false');
                core.setOutput('agent_action', 'closed_no_pr');
                return;
              }
              
              // Check for PRs created by Copilot Agent
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 20
              });
              
              // Look for PR created by copilot-swe-agent that mentions this issue
              for (const pr of prs) {
                if (pr.user.login === 'copilot-swe-agent[bot]' || pr.user.type === 'Bot') {
                  const { data: timeline } = await github.rest.issues.listEventsForTimeline({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  
                  // Check if this PR is linked to our issue
                  const prMentionsIssue = timeline.some(event => 
                    event.event === 'cross-referenced' && 
                    event.source?.issue?.number === pr.number
                  );
                  
                  if (prMentionsIssue || pr.body?.includes(`#${issueNumber}`)) {
                    console.log(`Found Copilot PR #${pr.number}: ${pr.title}`);
                    prFound = true;
                    prNumber = pr.number;
                    prBranch = pr.head.ref;
                    break;
                  }
                }
              }
              
              if (!prFound && attempt < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, delayMs));
              }
            }
            
            if (prFound) {
              console.log(`âœ… Copilot created PR #${prNumber} from branch ${prBranch}`);
              core.setOutput('pr_created', 'true');
              core.setOutput('pr_number', prNumber);
              core.setOutput('pr_branch', prBranch);
              core.setOutput('agent_action', 'created_pr');
            } else {
              console.log('â±ï¸ Timeout: No PR created within the waiting period.');
              core.setOutput('pr_created', 'false');
              core.setOutput('agent_action', 'timeout');
            }

      - name: Close issue with summary
        if: always() && steps.create_issue.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.create_issue.outputs.issue_number }}');
            const prCreated = '${{ steps.wait_for_pr.outputs.pr_created }}' === 'true';
            const agentAction = '${{ steps.wait_for_pr.outputs.agent_action }}';
            const prNumber = '${{ steps.wait_for_pr.outputs.pr_number }}';
            const prBranch = '${{ steps.wait_for_pr.outputs.pr_branch }}';
            
            // Skip if no issue was created
            if (!issueNumber || isNaN(issueNumber)) {
              console.log('Skipping issue comment - no issue was created');
              return;
            }
            
            let summaryComment = '## ðŸ¤– Copilot Agent Workflow Summary\n\n';
            
            if (agentAction === 'created_pr') {
              summaryComment += `âœ… **Status**: PR Created Successfully\n\n`;
              summaryComment += `- **PR**: #${prNumber}\n`;
              summaryComment += `- **Branch**: \`${prBranch}\`\n`;
              summaryComment += `- **Next Steps**:\n`;
              summaryComment += `  1. CI pipeline will run on the PR branch\n`;
              summaryComment += `  2. Review the generated tests in PR #${prNumber}\n`;
              summaryComment += `  3. Merge the PR if tests are satisfactory\n\n`;
              summaryComment += `Closing this issue as the tests have been generated.`;
            } else if (agentAction === 'closed_no_pr') {
              summaryComment += `â„¹ï¸ **Status**: No PR Created\n\n`;
              summaryComment += `The Copilot Agent closed this issue without creating a PR.\n`;
              summaryComment += `Possible reasons:\n`;
              summaryComment += `- No test generation was needed\n`;
              summaryComment += `- Tests already exist for the changed files\n`;
              summaryComment += `- Agent determined the changes don't require new tests\n`;
            } else if (agentAction === 'timeout') {
              summaryComment += `â±ï¸ **Status**: Timeout\n\n`;
              summaryComment += `The workflow timed out waiting for Copilot Agent to create a PR.\n`;
              summaryComment += `Possible reasons:\n`;
              summaryComment += `- Agent is still processing (check back later)\n`;
              summaryComment += `- Agent encountered an error\n`;
              summaryComment += `- Issue was not properly assigned to @copilot\n\n`;
              summaryComment += `**Action Required**: Check issue status and reassign to @copilot if needed.`;
            }
            
            // Add comment with summary
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: summaryComment
            });
            
            // Close issue if PR was created or if agent closed it
            if (agentAction === 'created_pr' || agentAction === 'closed_no_pr') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: 'completed'
              });
              console.log(`âœ… Issue #${issueNumber} closed with summary`);
            }

      - name: Trigger CI on agent branch
        if: steps.wait_for_pr.outputs.pr_created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBranch = '${{ steps.wait_for_pr.outputs.pr_branch }}';
            const prNumber = '${{ steps.wait_for_pr.outputs.pr_number }}';
            
            console.log(`Triggering CI workflow on branch: ${prBranch}`);
            
            // Trigger the CI workflow on the PR branch
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              ref: prBranch
            });
            
            console.log(`âœ… CI workflow triggered for PR #${prNumber}`);
            
            // Add comment to PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'ðŸš€ CI workflow triggered automatically to verify generated tests.'
            });

      - name: Post workflow summary
        if: always()
        run: |
          echo "## Workflow Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue**: #${{ steps.create_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Agent Action**: ${{ steps.wait_for_pr.outputs.agent_action }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.wait_for_pr.outputs.pr_created }}" = "true" ]; then
            echo "- **PR Created**: #${{ steps.wait_for_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: ${{ steps.wait_for_pr.outputs.pr_branch }}" >> $GITHUB_STEP_SUMMARY
            echo "- **CI Triggered**: âœ…" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **PR Created**: No" >> $GITHUB_STEP_SUMMARY
          fi
