#!/usr/bin/env zsh
set -euo pipefail

# Multi-module aware pre-commit hook for Java projects.
# Blocks commits when src/main changes lack corresponding src/test changes.
# Also triggers Copilot Agent issue to generate tests when missing.

repo_root_dir="$(git rev-parse --show-toplevel)"
cd "$repo_root_dir/beneficiaries"

# Detect staged main Java changes per module
changed_main=($(git diff --cached --name-only --diff-filter=AMR -- '**/src/main/java/**/*.java'))
if [[ ${#changed_main[@]} -eq 0 ]]; then
  exit 0
fi

missing_tests=()
for f in $changed_main; do
  # module path is everything up to src/main
  module_dir="${f%%/src/main/*}"
  rel_no_ext="${f%.java}"
  pkg_path="${rel_no_ext#${module_dir}/src/main/java/}"
  test_candidate="${module_dir}/src/test/java/${pkg_path}Test.java"
  alt_candidate="${module_dir}/src/test/java/${pkg_path}Tests.java"
  if [[ ! -f "$test_candidate" && ! -f "$alt_candidate" ]]; then
    missing_tests+="$f"
  fi
done

if [[ ${#missing_tests[@]} -gt 0 ]]; then
  echo "❌ Commit blocked: missing tests for changed source files:" >&2
  for m in $missing_tests; do
    echo "  - $m" >&2
  done

  branch_name="$(git rev-parse --abbrev-ref HEAD)"
  issue_title="Generate tests for branch ${branch_name} (beneficiaries)"
  issue_body=$(cat <<'EOF'
Pre-commit detected changed Java sources without matching tests.

Please generate unit, Spring slice, integration (Testcontainers), and BDD tests for the changed files.

Changed files:
EOF
  )
  for m in $missing_tests; do
    issue_body+=$'\n- '
    issue_body+="$m"
  done
  issue_body+=$'\n\nPrefer existing frameworks in repo (JUnit 5, Spring Boot Test, Mockito, Cucumber, Testcontainers); otherwise use standard stacks.\n'
  issue_body+=$"\nBranch: ${branch_name}\nRepository: beneficiaries\n\n#github-pull-request_copilot-coding-agent\n"

  if command -v gh >/dev/null 2>&1; then
    existing_id=$(gh issue list --search "$issue_title" --state open --json number --jq '.[0].number' 2>/dev/null || true)
    if [[ -n "$existing_id" ]]; then
      gh issue comment "$existing_id" --body "$issue_body" || true
    else
      gh issue create --title "$issue_title" --body "$issue_body" --label "tests" --label "copilot-agent" || true
    fi
  fi

  echo "Tip: use --no-verify to bypass locally only; PR checks still enforce tests." >&2
  exit 1
fi

exit 0
#!/usr/bin/env zsh
set -euo pipefail

# Pre-commit hook: ensures changed Java source files have corresponding tests.
# If missing, blocks commit and opens a GitHub Issue that triggers Copilot Agent.

repo_root_dir="$(git rev-parse --show-toplevel)"
cd "$repo_root_dir/beneficiaries"

# Collect staged Java source changes (added/modified/renamed) under src/main/java
changed_java_files=($(git diff --cached --name-only --diff-filter=AMR -- 'src/main/java/**/*.java'))

if [[ ${#changed_java_files[@]} -eq 0 ]]; then
  exit 0
fi

missing_tests=()

# Map src/main/java/.../Foo.java -> src/test/java/.../FooTest.java (basic heuristic)
for f in $changed_java_files; do
  rel_no_ext="${f%.java}"
  base_name="${rel_no_ext##*/}"
  pkg_path="${rel_no_ext#src/main/java/}"
  test_candidate="src/test/java/${pkg_path}Test.java"
  # Accept either *Test.java or *Tests.java
  alt_candidate="src/test/java/${pkg_path}Tests.java"

  if [[ ! -f "$test_candidate" && ! -f "$alt_candidate" ]]; then
    missing_tests+="$f"
  fi
done

if [[ ${#missing_tests[@]} -gt 0 ]]; then
  echo "❌ Commit blocked: missing tests for changed source files:" >&2
  for m in $missing_tests; do
    echo "  - $m" >&2
  done

  # Create or update an issue to trigger Copilot Agent test generation.
  # Requires GitHub CLI (gh) authenticated with repo access.
  branch_name="$(git rev-parse --abbrev-ref HEAD)"
  issue_title="Generate tests for branch ${branch_name} (beneficiaries)"

  issue_body=$(cat <<'EOF'
The pre-commit hook detected changed Java sources without matching tests.

Please generate unit, Spring slice, and Testcontainers-backed BDD tests for the changed files.

Context:
EOF
  )

  # Append changed file list to body
  for m in $missing_tests; do
    issue_body+=$'\n- '
    issue_body+="$m"
  done

  issue_body+=$'\n\nFramework detection: Use existing test frameworks if present (JUnit 5, Spring Boot Test, Mockito, Cucumber). If absent, default to JUnit 5 + Mockito + Spring Boot Test; BDD with Cucumber; integration via Testcontainers.\n'
  issue_body+=$"\nBranch: ${branch_name}\n"
  issue_body+=$"\nRepository: beneficiaries\n"
  issue_body+=$"\n#github-pull-request_copilot-coding-agent\n"

  if command -v gh >/dev/null 2>&1; then
    # Try to find existing open issue by title; otherwise create new
    existing_id=$(gh issue list --search "$issue_title" --state open --json number --jq '.[0].number' 2>/dev/null || true)
    if [[ -n "$existing_id" ]]; then
      gh issue comment "$existing_id" --body "$issue_body" || true
    else
      gh issue create --title "$issue_title" --body "$issue_body" --label "tests" --label "copilot-agent" || true
    fi
  else
    echo "Note: gh (GitHub CLI) not found; please install and authenticate to auto-open the Agent issue." >&2
  fi

  echo "\nTip: run with --no-verify to bypass locally, but PR checks will still block merges without tests." >&2
  exit 1
fi

exit 0
